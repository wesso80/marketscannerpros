services:
  - type: web
    name: marketscannerpros
    runtime: node
    buildCommand: npm install && npm run build
    startCommand: npm start
    envVars:
      - key: NODE_ENV
        value: production

  # ==========================================================================
  # Background Worker: Data Ingestion (Alpha Vantage)
  # Fetches OHLCV data, computes indicators locally, stores in DB + Redis
  # This eliminates per-user API calls - all users read from cache
  # ==========================================================================
  - type: worker
    name: msp-data-worker
    runtime: node
    buildCommand: npm install
    startCommand: npm run worker:ingest
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false
      - key: ALPHA_VANTAGE_API_KEY
        sync: false
      - key: ALPHA_VANTAGE_RPM
        value: "70"
      - key: UPSTASH_REDIS_REST_URL
        sync: false
      - key: UPSTASH_REDIS_REST_TOKEN
        sync: false

  # Cron Jobs for Alerts
  - type: cron
    name: alerts-price-check
    runtime: node
    schedule: "*/5 * * * *"  # Every 5 minutes
    buildCommand: echo "Cron job ready"
    startCommand: curl -X POST "$RENDER_EXTERNAL_URL/api/alerts/check" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: RENDER_EXTERNAL_URL
        fromService:
          name: marketscannerpros
          type: web
          property: url
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: alerts-signal-check
    runtime: node
    schedule: "*/10 * * * *"  # Every 10 minutes
    buildCommand: echo "Cron job ready"
    startCommand: curl -X POST "$RENDER_EXTERNAL_URL/api/alerts/signal-check" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: RENDER_EXTERNAL_URL
        fromService:
          name: marketscannerpros
          type: web
          property: url
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: alerts-smart-check
    runtime: node
    schedule: "*/5 * * * *"  # Every 5 minutes - derivatives/OI/funding alerts
    buildCommand: echo "Cron job ready"
    startCommand: curl -X POST "$RENDER_EXTERNAL_URL/api/alerts/smart-check" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: RENDER_EXTERNAL_URL
        fromService:
          name: marketscannerpros
          type: web
          property: url
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: alerts-strategy-check
    runtime: node
    schedule: "*/15 * * * *"  # Every 15 minutes
    buildCommand: echo "Cron job ready"
    startCommand: curl -X POST "$RENDER_EXTERNAL_URL/api/alerts/strategy-check" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: RENDER_EXTERNAL_URL
        fromService:
          name: marketscannerpros
          type: web
          property: url
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: daily-market-focus
    runtime: node
    schedule: "0 21 * * *"  # 9 PM UTC daily
    buildCommand: echo "Cron job ready"
    startCommand: curl -X POST "$RENDER_EXTERNAL_URL/api/jobs/generate-market-focus" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: RENDER_EXTERNAL_URL
        fromService:
          name: marketscannerpros
          type: web
          property: url
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: daily-scan
    runtime: node
    schedule: "30 21 * * *"  # 9:30 PM UTC daily
    buildCommand: echo "Cron job ready"
    startCommand: curl -X POST "$RENDER_EXTERNAL_URL/api/jobs/scan-daily" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: RENDER_EXTERNAL_URL
        fromService:
          name: marketscannerpros
          type: web
          property: url
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: learning-outcomes
    runtime: node
    schedule: "*/15 * * * *"  # Every 15 minutes - process learning machine predictions
    buildCommand: echo "Cron job ready"
    startCommand: curl -X POST "$RENDER_EXTERNAL_URL/api/jobs/learning-outcomes" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: RENDER_EXTERNAL_URL
        fromService:
          name: marketscannerpros
          type: web
          property: url
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: journal-auto-close
    runtime: node
    schedule: "*/5 * * * *"  # Every 5 minutes - auto-close TP/SL/time-stop eligible journal trades
    buildCommand: echo "Cron job ready"
    startCommand: curl -X POST "$RENDER_EXTERNAL_URL/api/jobs/journal-auto-close?limit=200" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: RENDER_EXTERNAL_URL
        fromService:
          name: marketscannerpros
          type: web
          property: url
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: stale-auto-draft-cleanup
    runtime: node
    schedule: "15 0 * * *"  # Daily at 00:15 UTC - close stale scanner auto drafts older than 48h
    buildCommand: npm install
    startCommand: npm run worker:cleanup:stale-auto-drafts
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false