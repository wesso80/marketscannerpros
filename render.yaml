services:
  - type: web
    name: marketscannerpros
    runtime: node
    buildCommand: npm install && npm run build
    startCommand: npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: ALPHA_VANTAGE_RPM
        value: "400"

  # ==========================================================================
  # Background Worker: Data Ingestion (Alpha Vantage)
  # Fetches OHLCV data, computes indicators locally, stores in DB + Redis
  # This eliminates per-user API calls - all users read from cache
  # ==========================================================================
  - type: worker
    name: msp-data-worker
    runtime: node
    buildCommand: npm install
    startCommand: npm run worker:ingest
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false
      - key: ALPHA_VANTAGE_API_KEY
        sync: false
      - key: ALPHA_VANTAGE_RPM
        value: "200"
      - key: UPSTASH_REDIS_REST_URL
        sync: false
      - key: UPSTASH_REDIS_REST_TOKEN
        sync: false
      - key: COINGECKO_API_KEY
        sync: false

  # Cron Jobs for Alerts
  - type: cron
    name: alerts-price-check
    runtime: node
    schedule: "0-59/5 * * * *"  # Every 5 minutes (offset :00)
    buildCommand: echo "Cron job ready"
    startCommand: curl -fL --retry 3 --retry-delay 15 --retry-all-errors --connect-timeout 10 --max-time 120 -X POST "$WEB_URL/api/alerts/check" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: WEB_URL
        value: "https://marketscannerpros.onrender.com"
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: alerts-signal-check
    runtime: node
    schedule: "3-59/10 * * * *"  # Every 10 minutes (offset :03)
    buildCommand: echo "Cron job ready"
    startCommand: curl -fL --retry 3 --retry-delay 15 --retry-all-errors --connect-timeout 10 --max-time 120 -X POST "$WEB_URL/api/alerts/signal-check" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: WEB_URL
        value: "https://marketscannerpros.onrender.com"
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: alerts-smart-check
    runtime: node
    schedule: "1-59/5 * * * *"  # Every 5 minutes (offset :01) - derivatives/OI/funding alerts
    buildCommand: echo "Cron job ready"
    startCommand: curl -fL --retry 3 --retry-delay 15 --retry-all-errors --connect-timeout 10 --max-time 120 -X POST "$WEB_URL/api/alerts/smart-check" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: WEB_URL
        value: "https://marketscannerpros.onrender.com"
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: alerts-strategy-check
    runtime: node
    schedule: "4,19,34,49 * * * *"  # Every 15 minutes (offset :04)
    buildCommand: echo "Cron job ready"
    startCommand: curl -fL --retry 3 --retry-delay 15 --retry-all-errors --connect-timeout 10 --max-time 120 -X POST "$WEB_URL/api/alerts/strategy-check" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: WEB_URL
        value: "https://marketscannerpros.onrender.com"
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: daily-market-focus
    runtime: node
    schedule: "0 21 * * *"  # 9 PM UTC daily
    buildCommand: echo "Cron job ready"
    startCommand: curl -fL --retry 3 --retry-delay 15 --retry-all-errors --connect-timeout 10 --max-time 120 -X POST "$WEB_URL/api/jobs/generate-market-focus" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: WEB_URL
        value: "https://marketscannerpros.onrender.com"
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: daily-scan
    runtime: node
    schedule: "30 21 * * *"  # 9:30 PM UTC daily
    buildCommand: echo "Cron job ready"
    startCommand: curl -fL --retry 3 --retry-delay 15 --retry-all-errors --connect-timeout 10 --max-time 290 -X POST "$WEB_URL/api/jobs/scan-daily" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: WEB_URL
        value: "https://marketscannerpros.onrender.com"
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: catalyst-study-compute
    runtime: node
    schedule: "14,44 * * * *"  # Every 30 minutes (offset :14) - incremental catalyst study computation
    buildCommand: echo "Cron job ready"
    startCommand: curl -fL --retry 1 --retry-delay 10 --retry-all-errors --connect-timeout 10 --max-time 270 -X POST "$WEB_URL/api/catalyst/study/compute?limit=5" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: WEB_URL
        value: "https://marketscannerpros.onrender.com"
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: catalyst-overnight-bulk
    runtime: node
    schedule: "0 22 * * *"  # 10 PM UTC (5 PM ET) - bulk compute after market close
    buildCommand: echo "Cron job ready"
    startCommand: curl -fL --retry 1 --retry-delay 10 --retry-all-errors --connect-timeout 10 --max-time 270 -X POST "$WEB_URL/api/catalyst/study/compute?limit=50" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: WEB_URL
        value: "https://marketscannerpros.onrender.com"
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: learning-outcomes
    runtime: node
    schedule: "9,24,39,54 * * * *"  # Every 15 minutes (offset :09) - process learning machine predictions
    buildCommand: echo "Cron job ready"
    startCommand: curl -fL --retry 3 --retry-delay 15 --retry-all-errors --connect-timeout 10 --max-time 120 -X POST "$WEB_URL/api/jobs/learning-outcomes" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: WEB_URL
        value: "https://marketscannerpros.onrender.com"
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: journal-auto-close
    runtime: node
    schedule: "2-59/5 * * * *"  # Every 5 minutes (offset :02) - auto-close TP/SL/time-stop eligible journal trades
    buildCommand: echo "Cron job ready"
    startCommand: curl -fL --retry 3 --retry-delay 15 --retry-all-errors --connect-timeout 10 --max-time 120 -X POST "$WEB_URL/api/jobs/journal-auto-close?limit=200" -H "x-cron-secret:$CRON_SECRET" -H "Content-Type:application/json"
    envVars:
      - key: WEB_URL
        value: "https://marketscannerpros.onrender.com"
      - key: CRON_SECRET
        sync: false

  - type: cron
    name: stale-auto-draft-cleanup
    runtime: node
    schedule: "15 0 * * *"  # Daily at 00:15 UTC - close stale scanner auto drafts older than 48h
    buildCommand: npm install
    startCommand: npm run worker:cleanup:stale-auto-drafts
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false

  # ========================================================================
  # UPE Scheduler Wiring (Phase D)
  # US session aligned using UTC schedules (EST baseline; adjust seasonally)
  # ========================================================================
  - type: cron
    name: upe-global-open
    runtime: node
    schedule: "35 14 * * 1-5"  # 09:35 ET (EST baseline)
    buildCommand: npm install
    startCommand: npm run worker:upe:global:open
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false

  - type: cron
    name: upe-global-close
    runtime: node
    schedule: "5 21 * * 1-5"  # 16:05 ET (EST baseline)
    buildCommand: npm install
    startCommand: npm run worker:upe:global:close
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false

  - type: cron
    name: upe-crcs-hourly
    runtime: node
    schedule: "8 * * * *"  # Hourly at :08 (staggered from other crons)
    buildCommand: npm install
    startCommand: npm run worker:upe:crcs:hourly
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false